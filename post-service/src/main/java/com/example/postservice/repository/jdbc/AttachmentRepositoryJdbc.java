package com.example.postservice.repository.jdbc;

import com.example.commericalcommon.dto.object.AttachmentDTO;
import com.example.commericalcommon.dto.response.AttachmentResponse;
import lombok.AccessLevel;
import lombok.RequiredArgsConstructor;
import lombok.experimental.FieldDefaults;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Objects;

@Repository
@RequiredArgsConstructor
@FieldDefaults(level = AccessLevel.PRIVATE, makeFinal = true)
@Slf4j
public class AttachmentRepositoryJdbc {
    NamedParameterJdbcTemplate namedParameterJdbcTemplate;

    public List<AttachmentResponse> getAllAttachments(Long objectId, String objectType) {
        String sql = """
                select am.id,
                       am.display_name,
                       a.mime_type,
                       a.size,
                       a.thumbnail,
                       a.file_path_sm,
                       a.file_path_lg,
                       a.file_path_original
                from attachment_map am
                         join attachment a on am.attachment_id = a.id
                where object_id = :object_id
                  and object_type = :object_type
                """;
        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("object_id", objectId)
                .addValue("object_type", objectType);
        return namedParameterJdbcTemplate.query(sql, params, (rs, rowNum) ->
                AttachmentResponse.builder()
                        .id(rs.getLong("id"))
                        .name(rs.getString("name"))
                        .thumbnail(rs.getString("thumbnail"))
                        .pathSmall(rs.getString("path_small"))
                        .pathLarge(rs.getString("path_large"))
                        .pathOriginal(rs.getString("path_original"))
                        .size(rs.getString("size"))
                        .type(rs.getString("type"))
                        .build());
    }

    public AttachmentDTO checkSumExists(String checkSum) {
        String sql = """
                select id, file_name
                from attachment
                where checksum = :checksum
                and status = 'A'
                """;
        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("checksum", checkSum);
        List<AttachmentDTO> attachments = namedParameterJdbcTemplate.query(sql, params,
                (rs, rowNum) ->
                        AttachmentDTO.builder()
                                .id(rs.getLong("id"))
                                .fileName(rs.getString("name"))
                                .build());
        return attachments.isEmpty() ? null : attachments.getFirst();
    }

    public void insertAttachmentMap(String code,
                                    String displayName,
                                    String objectType,
                                    Long objectId,
                                    String clientUploadCode,
                                    String description,
                                    Long createdBy,
                                    String status,
                                    Integer orderNo,
                                    Long attachmentId) {
        String sql = """
                INSERT INTO attachment_map (
                                code,
                                display_name,
                                object_type,
                                object_id,
                                client_upload_code,
                                description,
                                created_by,
                                status,
                                order_no,
                                attachment_id
                            ) VALUES (
                                :code,
                                :displayName,
                                :objectType,
                                :objectId,
                                :clientUploadCode,
                                :description,
                                :createdBy,
                                :status,
                                :orderNo,
                                :attachmentId
                            )
                """;
        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("code", code)
                .addValue("displayName", displayName)
                .addValue("objectType", objectType)
                .addValue("objectId", objectId)
                .addValue("clientUploadCode", clientUploadCode)
                .addValue("description", description)
                .addValue("createdBy", createdBy)
                .addValue("status", status)
                .addValue("orderNo", orderNo)
                .addValue("attachmentId", attachmentId);
        namedParameterJdbcTemplate.update(sql, params);
    }

    public Long insert(AttachmentDTO dto) {
        KeyHolder keyHolder = new GeneratedKeyHolder();
        String sql = """
                INSERT INTO attachment (
                    mime_type,
                    file_name,
                    thumbnail,
                    file_path_sm,
                    file_path_lg,
                    file_path_original,
                    checksum,
                    size,
                    description,
                    created_by,
                    folder,
                    source,
                    is_sync_vultr,
                    is_sync_vultr_error
                ) VALUES (
                    :mimeType,
                    :fileName,
                    :thumbnail,
                    :filePathSm,
                    :filePathLg,
                    :filePathOriginal,
                    :checksum,
                    :size,
                    :description,
                    :createdBy,
                    :folder,
                    :source,
                    :isSyncVultr,
                    :isSyncVultrError
                )
                """;

        MapSqlParameterSource params = new MapSqlParameterSource()
                .addValue("mimeType", dto.getMimeType())
                .addValue("fileName", dto.getFileName())
                .addValue("thumbnail", dto.getThumbnail())
                .addValue("filePathSm", dto.getFilePathSm())
                .addValue("filePathLg", dto.getFilePathLg())
                .addValue("filePathOriginal", dto.getFilePathOriginal())
                .addValue("checksum", dto.getChecksum())
                .addValue("size", dto.getSize())
                .addValue("description", dto.getDescription())
                .addValue("createdBy", dto.getCreatedBy())
                .addValue("folder", dto.getFolder() != null ? dto.getFolder() : "uploads")
                .addValue("source", dto.getSource() != null ? dto.getSource() : "s3")
                .addValue("isSyncVultr", dto.getIsSyncVultr() != null ? dto.getIsSyncVultr() : false)
                .addValue("isSyncVultrError", dto.getIsSyncVultrError() != null ? dto.getIsSyncVultrError() : false);

        namedParameterJdbcTemplate.update(sql, params);
        return Objects.requireNonNull(keyHolder.getKey()).longValue();
    }


}
